## Redis-用户日活跃统计

这篇文章是面试题延伸过来的知识点:

> Redis如何实现统计一亿用户的日活跃情况, 并快速检索任意时间段内的活跃用户数量?


### 1. 使用String存储 (不可行)

如果用普通的字符串来存储, 是不可行的。由于用户量较大, 那么一个最简单的key value对, 一亿的用户量也会产生以G为单位的量。

比如: key=aaa, value=1; 占用内存为48bit, 假设每个用户日活跃需要占用一对kv, 那么一亿就是(48*100000000)/1024/1024/1024=4.47G。这还是一天的量。

所以String存储数据不合理。

### 2. bitmap方案

在[布隆过滤器](database/Redis/interview/redis_bloomfilter.md)这篇文章中, 我们简单介绍了bitmap。

利用这种方式, 我们可以把value作为一个位, 来表示用户日活状态。

#### 2.1 用户日活统计方案设计

##### 2.1.1 活跃标识

假设用户登录时我们就统计当日用户活跃, 那么使用setbit命令和用户id(假设id=123456)标记, 当前日期用户状态:

```shell

// login:20210223表示key, 即当前登录日期; 123456表示offset, 即当前用户id作为偏移量; 1表示value, 即二进制的位1, 表示当前日期活跃
setbit login:20210223 123456 1
```

##### 2.1.2 每日用户活跃统计

```shell
bitcount login:20210223
```

##### 2.1.3 连续3天活跃用户统计

对于一个时间段的统计操作可以使用`bitop`命令, 而且支持使用`AND(与)`, `OR(或)`, `XOR(异或)`,`NOT(非)`四种操作。

如果我们想要获取近3天活跃用户数量的话, 就使用bitmap的`AND`操作即可, 操作之后会形成一个新的bitmap. 我们可以命名为`login:20210223:r3`

```shell
bitop and login:20210223:r3 login:20210223 login:20210222 login:20210221
```

然后我们在对新的bitmap `login:20210223:r3`使用bitcount命令, 用户统计用户数量, 或者使用`getbit`命令查看某个用户是否为活跃用户。


