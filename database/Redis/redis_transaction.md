## Redis-事务

Redis也是具有事务特性, 通过`multi`, `exec`, `discard`, `watch`, `unwatch`来实现事务功能。

Redis的事务会保证多个命令一次性, 按顺序执行, 在执行期间可以保证不会中断事务去执行其他命令。

**但是要注意的是, Redis的事务机制是不能保证原子性的, 它只保证隔离性和一致性。**

### 1. Redis事务详解

Redis事务形式如下:

```shell
multi

command1()
command2()

...

commandn()

exec/discard
```

`multi`表示事务的开始, 在multi之后的命令都不会执行, 全部进入事务队列, 直到服务器接收到`exec`或者`discard`命令才会开始执行或放弃整个事务, 当执行完整个事务后, Redis会一次性返回所有命令的运行结果。

### 2. Redis事务的ACID原则

与关系型数据库一样, Redis事务也有ACID原则, 但是**Redis 的事务满足一致性和隔离性，但是原子性和持久性就不支持了**。

#### 2.1 原子性

对于Redis而言, 单个命令的执行是具有原子性的, 也就是说单个Redis命令, 要么成功, 要么失败。

**而且Redis放弃了事务的回滚机制, 在整个事务执行阶段, 如果操作失败, 依然会继续后面的redis命令。**

Redis放弃事务回滚的原因有两点:

- Redis操作失败的原因只可能是语法错误或者操作数据库类型错误, 这些都是在开发层面可以解决的问题, 不会进入生产环境, 因此不需要回滚;

- Redis内部设计本来就推崇简单和高性能, 所以不需要回滚能力。

#### 2.2 一致性

一致性的意思就是确保执行Redis命令后, 数据的结果是完全正确的。

- 如果Redis采用内存模式, 那么重启redis之后, redis数据将会为空, 满足一致性;

- 如果redis持久化选择RDB模式, 那么在执行事务期间都不可能中断事务去执行RDB, 只有在事务执行完成后, 才肯呢个触发RDB进行持久化工作。所以在 RDB 持久化模式下，无论事务执行是否成功，，所以满足一致性。那么AOF模式下, 也是同理。

#### 2.3 隔离性

Redis的多个事务并发互不干扰。由于Redis使用单线程方式来执行事务并且可以保证整个事务执行期间不会中断去执行其他命令, 所以Redis的事务一定保证隔离性。

#### 2.4 持久性

- 如果 Redis 采用内存模式，因为数据不会持久化，所以持久化无法保证;

- 如果 Redis 采用 RDB 模式，服务器只会在特定的条件才会触发，如果 Redis 执行事务后，没有触发 bgsave 操作，则无法保证持久化;

- 如果 Redis 采用 AOF 模式，则分为以下三种情况:

    - 如果选择的是 always，则会同步调用不同操作，将命令数据写入到硬盘中，所以具有持久性;

    - 如果现在的是 everysec 或者 no，则依然需要在特定条件下触发，否则无法命令数据可以刷入硬盘，所以不具有持久性


