## <center>消息队列MQ 基础</center>

### 1. 什么是消息队列?

> 队列是一种先进先出的数据结构。

![queue](/distributed/MQ/img/queue.png)

java中已经实现了不少的队列: 

![java_queue](/distributed/MQ/img/java_queue.png)

消息队列可以简单理解为: **把要传输的数据放在队列中**

![message_queue](/distributed/MQ/img/message_queue.png)

- 把数据放到消息队列叫做**生产者**
- 从消息队列中取数据叫做**消费者**

### 2. 为什么要用消息队列?

- 解耦

- 异步

- 削峰/限流: 当每秒请求数过高, 系统请求不过来时, 可以先将大量的请求存入消息队列, 然后系统根据自己能够处理的请求数去消息队列中拿数据。

### 3. 使用消息队列产生的问题?

- **高可用:** 消息队列肯定是不能单机的, 如果是单机的消息队列, 万一这台机器挂了, 那么整个系统几乎就不可用。所以当项目使用消息队列, 最好是`集群/分布式`。

- **数据丢失问题:** 我们将数据写到消息队列上, 但是系统还没来得及获取数据, 就挂掉了, 如果没有做任何措施, 我们的数据就丢了。所以消息队列的数据也需要保存。

- **系统复杂性提高:** 加入MQ后, 你需要保证消息没有被重复消费, 处理消息丢失的情况, 保证消息传递的顺序性等。

- **一致性问题:** 消息队列可以实现异步, 确实可以提高系统响应速度, 但是, 如果消息的真正消费者并没有正确消费消息怎么办?这样会导致数据不一致的情况。

### 4. JMS 与 AMQP

#### 4.1 JMS

**JMS(Jav Message Service, java消息服务) API是一个消息服务的标准或者说是规范, 允许应用程序组件基于JavaEE平台创建, 发送, 接收和读取消息。**

##### 4.1.1 JMS消息模型

1. 点对点(P2P)模型

使用队列(queue)作为消息通信载体; 满足生产者与消费者模型, 一条消息只能被一个消费者使用, 未被消费的消息在队列中保留知道被消费或超时。

2. 发布/订阅(Pub/Sub)模型

使用主题(Topic)作为消息通信载体, 类似于广播模式; 发布者发布一条消息, 该消息通过主题传递给所有的订阅者, **在一条消息广播之后才订阅的用户是收不到该条消息**

##### 4.1.2 JMS消息正文格式

- StreamMessage: Java原始值的数据流
- MapMessage: 键值对
- TextMessage: 一个字符串对象
- ObjectMessage: 一个序列化的Java对象
- BytesMessage: 一个字节的数据流

#### 4.2 AMQP

AMQP(Advanced Message Queuing Protocol), 提供统一消息服务的应用层标准**高级消息队列协议**(二进制应用层协议), 为面向消息的中间件设计。

**基于此协议的客户端与消息中间件可传递消息, 并不受客户端/中间件类型, 不同开发语言等条件的限制。**

JMS与AMQP对比来看:

- AMQP为消息定义了线路层(wire-level protocol)的协议, 而JMS所定义的是API的规范。在Java体系中, 都可以通过JMS进行交互, 但是对跨平台的支持较差。而AMQP具有跨平台, 跨语言特性。

- JMS支持TextMessage, MapMessage等复杂的消息类型; 而AMQP仅支持byte[]消息类型(复杂的类型可以序列化后发送)。

- 由于Exchange提供的路由算法, AMQP可以提供多样化的路由方式来传递消息到消息队列, 而JMS仅支持`队列`和`发布订阅`方式。

AMQP常见的消息队列对比:

- ActiveMQ的社区比较成熟, 但是ActiveMQ的性能较差, 范本迭代很慢, 不推荐使用。
- RabbitMQ在吞吐量方面虽然不如Kafka和RocketMQ, 但是它的并发能力很强, 性能极好, 延时很低, 达到微秒级。但是由于RabbitMQ是基于erlang开发, 所以很少有公司对其深入研究和定制。所以如果业务场景对并发量要求不高(十万级, 百万级), 那么RabbitMQ一定是首选。如果是大数据领域的实时计算,日志采集等场景, 用kafka是业内的标准。
- RocketMQ的社区活跃度不高, 文档比较简单
- kafka的特点很明显, 虽然核心功能不多, 但是超高的吞吐量, ms级的延迟, 极高的可用性以及可靠性。唯一的不足就是, 有可能消息重复消费, 造成数据准确性会造成轻微的影响。


