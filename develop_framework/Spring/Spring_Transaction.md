## <center>Spring Transaction</center>

在日常开发中, 只要涉及到业务逻辑的开发都一定要去深入理解事务, 这不仅是面试高频提问点, 也是实际开发中必备技能。所以很重要!!!

我们既要知道事务的概念, 还要知道事务在Spring中是如何支持的。

### 1. 什么是事务?

**事务是逻辑上的一组操作, 要么都执行, 要么都不执行。**

系统中的每个业务方法可能包括了多个原子性的数据库操作, 这些操作是有依赖的, 它们要么都执行, 要么都不执行。

而且事务能否生效的关键在于数据库引擎是否支持事务。例如常用的MySQL数据库默认使用支持事务的`innodb`引擎。
但是, 如果数据库引擎变为`myisam`, 那么程序也无法再支持事务。

### 2. 事务的特性(ACID)了解吗?

![事务特性](/develop_framework/Spring/img/事务特性.png)
- **原子性**: 事务是最小的执行单位, 不允许在分割。事务的原子性确保动作要么全部完成, 要么完全不起作用。
- **一致性**: 执行事务前后, 数据保持一致。
- **隔离性**: 并发访问数据库时, 一个事务的执行不应影响其他事务的执行。
- **持久性**: 一个事务被提交后, 对数据库中数据的改变是持久的, 即使数据库发生故障也不应该对其有任何影响。

> 在学习Spring的事务的支持和管理之前, 要先知道Mysql是怎样保证原子性的?

想要保证事务的原子性, 就需要在发生异常时, 对已经执行的操作进行回滚。在MySQL中, 恢复机制是通过**回滚日志(undo log)**实现的, 所有事务进行的修改都会先记录到这个回滚日志中, 然后在执行相关操作。如果执行过程中遇到异常的话, 我们直接利用回滚日志中的信息将数据回滚到修改之前的样子即可!而且, 回滚日志会先于数据持久化到磁盘上。这样就保证了即使遇到数据库突然宕机等情况, 当用户再次启动数据库的时候, 数据库还能够通过查询回滚日志来执行未完成的事务。

### 3. Spring对事务的支持

Spring对事务支持的前提, 就是数据库要使用支持事务的引擎!!!

#### 3.1 Spring支持两种方式的事务管理

1. 编程式事务管理
    通过`TransactionTemplate`或者`TransactionManager`手动管理事务, 但是实际应用很少使用, 因为跟业务逻辑代码的耦合太高了。

2. 声明式事务管理
    通过Spring AOP实现(基于`@Transactional`注解的方式最多)。 这是实际项目中最常用的方式, 也是利用AOP的特性, 贯穿整个业务模块, 实现统一的事务管理。

#### 3.2 Spring事务管理接口

Spring框架中, 事务管理相关的最重要的3个接口:
- `PlatformTransactionManager`: 事务管理器, Spring事务策略的核心。
- `TransactionDefinition`: 事务定义信息(事务隔离级别, 传播行为, 超时, 只读, 回滚规则)。
- `TransactionStatus`: 事务运行状态。

`PlatformTransactionManager`会根据`TransactionDefinition`的定义, 比如事务超时时间, 隔离级别, 传播行为等来进行事务管理, 而`TransactionStatus`接口提供方法获取事务
相应的状态比如是否新事务, 是否可以回滚。

